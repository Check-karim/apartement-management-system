# Apartment Management System - Cursor AI Rules

## Project Overview
This is a mobile-first apartment management system built with Next.js, TypeScript, Tailwind CSS, and MySQL. The system supports admin and building manager roles for managing apartments and tenant notifications.

## Technology Stack
- **Frontend**: Next.js 15, React 19, TypeScript
- **Styling**: Tailwind CSS v4 (mobile-first approach)
- **Database**: MySQL
- **Authentication**: NextAuth.js with custom credentials
- **Forms**: React Hook Form with Zod validation
- **Icons**: Lucide React
- **Notifications**: React Hot Toast

## Code Standards

### Mobile-First Design
- All components MUST be designed for mobile devices first
- Use responsive design principles with `sm:`, `md:`, `lg:` prefixes sparingly
- Default styles should work perfectly on mobile (320px - 768px)
- Show "Download App" banner on desktop browsers
- Include online/offline status indicator

### File Structure
```
src/
├── app/
│   ├── (auth)/                    # Authentication pages
│   │   └── login/
│   │       └── page.tsx
│   ├── admin/                     # Admin dashboard
│   │   ├── page.tsx               # Main dashboard
│   │   ├── managers/              # Manager management
│   │   │   ├── page.tsx           # List all managers
│   │   │   ├── create/            # Create new manager
│   │   │   │   └── page.tsx
│   │   │   └── [id]/              # Edit existing manager
│   │   │       └── page.tsx
│   │   ├── buildings/             # Building management
│   │   │   ├── page.tsx           # List all buildings
│   │   │   ├── create/            # Create new building
│   │   │   │   └── page.tsx
│   │   │   └── [id]/              # Building details & edit
│   │   │       ├── page.tsx       # Building details
│   │   │       └── edit/
│   │   │           └── page.tsx   # Edit building
│   │   ├── apartments/            # Apartment management
│   │   │   ├── page.tsx           # List all apartments
│   │   │   ├── create/            # Create new apartment
│   │   │   │   └── page.tsx
│   │   │   └── [id]/              # Apartment details & edit
│   │   │       ├── page.tsx       # Apartment details
│   │   │       └── edit/
│   │   │           └── page.tsx   # Edit apartment
│   │   ├── reports/               # Reports section
│   │   │   ├── page.tsx           # Reports hub
│   │   │   ├── bills/
│   │   │   │   └── page.tsx       # Bill reports
│   │   │   ├── payments/
│   │   │   │   └── page.tsx       # Payment reports
│   │   │   ├── apartments/
│   │   │   │   └── page.tsx       # Apartment reports
│   │   │   └── buildings/
│   │   │       └── page.tsx       # Building reports
│   │   ├── notifications/         # Notifications section
│   │   │   ├── page.tsx           # Notifications hub
│   │   │   ├── maintenance/
│   │   │   │   └── page.tsx       # Maintenance notifications
│   │   │   ├── water/
│   │   │   │   └── page.tsx       # Water notifications
│   │   │   └── compound/
│   │   │       └── page.tsx       # Compound notifications
│   │   ├── settings/              # Settings section
│   │   │   ├── page.tsx           # Settings hub
│   │   │   ├── currency/
│   │   │   │   └── page.tsx       # Currency settings
│   │   │   └── water-formula/
│   │   │       └── page.tsx       # Water formula settings
│   │   └── profile/               # Profile management
│   │       └── page.tsx           # Admin profile
│   ├── manager/                   # Manager dashboard
│   │   └── page.tsx
│   ├── api/                       # API routes
│   │   ├── auth/
│   │   │   └── [...nextauth]/
│   │   │       └── route.ts       # NextAuth configuration
│   │   ├── users/
│   │   │   └── managers/
│   │   │       ├── route.ts       # List/Create managers
│   │   │       └── [id]/
│   │   │           └── route.ts   # Get/Update/Delete individual manager
│   │   ├── buildings/
│   │   │   ├── route.ts           # List/Create buildings
│   │   │   └── [id]/
│   │   │       └── route.ts       # Get/Update/Delete individual building
│   │   ├── apartments/
│   │   │   ├── route.ts           # List/Create apartments
│   │   │   └── [id]/
│   │   │       └── route.ts       # Get/Update/Delete individual apartment
│   │   └── currencies/
│   │       ├── route.ts           # List/Create currencies
│   │       └── [id]/
│   │           └── route.ts       # Get/Update/Delete individual currency
│   ├── components/                # Shared components
│   │   ├── mobile-header.tsx
│   │   ├── conditional-header.tsx
│   │   └── app-install-banner.tsx
│   ├── layout.tsx                 # Root layout
│   ├── page.tsx                   # Home page
│   ├── providers.tsx              # Context providers
│   └── globals.css                # Global styles
├── lib/
│   ├── db.ts                      # Database connection
│   └── auth.ts                    # Authentication config
└── types/
    └── index.ts                   # TypeScript type definitions
```

### Component Guidelines
1. **Mobile-First Components**: Always design for mobile screens first
2. **TypeScript**: Use strict typing for all props and state
3. **Tailwind Classes**: Use semantic class names, prefer utility classes
4. **Accessibility**: Include proper ARIA labels and keyboard navigation
5. **Performance**: Optimize for mobile networks (lazy loading, minimal JS)

### API Routes
- Use Next.js 13+ App Router API routes
- Implement proper error handling and validation
- Return consistent JSON responses
- Include proper HTTP status codes
- Add request/response logging for debugging
- **Authentication**: `/api/auth/[...nextauth]` - NextAuth.js configuration
- **Manager CRUD**: `/api/users/managers` (GET, POST) and `/api/users/managers/[id]` (GET, PUT, DELETE)
- **Building CRUD**: `/api/buildings` (GET, POST) and `/api/buildings/[id]` (GET, PUT, DELETE)
- **Apartment CRUD**: `/api/apartments` (GET, POST) and `/api/apartments/[id]` (GET, PUT, DELETE)
- **Currency CRUD**: `/api/currencies` (GET, POST) and `/api/currencies/[id]` (GET, PUT, DELETE)
- **Water Invoices**: `/api/water/invoices` (GET, POST) and `/api/water/invoices/[id]` (GET, PUT, DELETE)
- **Water Bills**: `/api/water/bills` (GET, POST) and `/api/water/bills/[id]` (GET, PUT, DELETE)
  - POST accepts `invoice_id` and `meter_readings` array
  - Auto-calculates and creates bills
- **Pompe Settings**: `/api/water/pompe` (GET, POST) - per-building pump electricity settings
- **SMS Notifications**: `/api/sms/send` (POST) - send water bill SMS notifications via TextBee
  - Returns detailed results (sent, failed, no_phone)
  - Integrates with TextBee API (https://api.textbee.rw)
  - Requires API key configuration in settings
- **Settings Management**: `/api/settings` (GET, POST) - manage system configuration
  - GET with ?keys=key1,key2 for specific settings
  - POST with settings array for batch updates
- **Contract Templates**: `/api/contracts/templates` (GET, POST) and `/api/contracts/templates/[id]` (GET, PUT, DELETE)
- **Generate Contract**: `/api/contracts/generate` (POST) - generate contract from template
- **File Upload**: `/api/upload` (POST) - upload tenant documents, contracts, invoices
- All endpoints support filtering via query parameters (e.g., `?building_id=1`)

### Database Patterns
- Use MySQL with mysql2 library
- Implement proper connection pooling
- Use prepared statements to prevent SQL injection
- Include proper error handling and connection cleanup
- Follow the schema defined in database.sql
- Database triggers automatically maintain `buildings.total_apartments` count
- Triggers handle INSERT, UPDATE, and DELETE operations on apartments table

### Authentication Rules
- Admin credentials: username='admin', password='admin' (predefined)
- Building managers created and managed by admin
- Use NextAuth.js for session management
- Implement proper role-based access control
- Secure API routes with middleware
- Manager CRUD operations (Create, Read, Update, Delete) admin-only
- Password updates optional (leave blank to keep current)
- Account activation/deactivation toggle for managers

### State Management
- Use React hooks for local state
- Implement proper loading and error states
- Use React Hot Toast for user feedback
- Handle offline scenarios gracefully

### UI/UX Guidelines
- **Color Scheme**: Use modern, accessible colors
- **Typography**: Clear hierarchy with readable fonts
- **Spacing**: Consistent padding and margins
- **Buttons**: Large touch targets (min 44px)
- **Forms**: Clear validation messages and feedback
- **Navigation**: Simple, intuitive mobile navigation
- **Input Fields**: Dark text (`text-gray-900`) with visible placeholders (`placeholder-gray-500`)
- **Form Layout**: Mobile-first with proper spacing and touch-friendly controls
- **Loading States**: Spinner animations for async operations
- **Error Handling**: Toast notifications with proper color coding

### Error Handling
- Graceful error boundaries
- User-friendly error messages
- Proper logging for debugging
- Fallback UI for network errors
- Offline capability notifications

### Performance Requirements
- Fast Time to Interactive (TTI) on mobile
- Minimal JavaScript bundle size
- Optimized images and assets
- Progressive Web App (PWA) capabilities
- Efficient database queries

### Security Practices
- Input validation on both client and server
- SQL injection prevention
- XSS protection
- CSRF protection with NextAuth
- Secure password hashing (bcrypt)
- Rate limiting for API endpoints

## Naming Conventions
- **Files**: kebab-case (apartment-list.tsx)
- **Components**: PascalCase (ApartmentCard)
- **Functions**: camelCase (getUserData)
- **Variables**: camelCase (apartmentData)
- **Constants**: SCREAMING_SNAKE_CASE (MAX_RENT_AMOUNT)
- **Database**: snake_case (apartment_id, created_at)

## Testing Guidelines
- Write unit tests for utility functions
- Test API endpoints with proper mocking
- Test components with mobile-first approach
- Include accessibility testing
- Test offline functionality

## Deployment Notes
- Optimize for production builds
- Environment variables for database connection
- Proper error logging and monitoring
- Mobile performance optimization
- PWA manifest and service worker

## Development Workflow
1. Start with mobile design (320px width)
2. Implement TypeScript interfaces first
3. Build API endpoints with proper validation
4. Create reusable components
5. Test on various mobile devices
6. Optimize performance and accessibility

## Water Billing System

### Water Bill Calculation Formula
The system implements a comprehensive water billing calculation:

**Step 1: Calculate Water Consumption**
- `used_m3` = `current_meter_reading` - `previous_meter_reading`
- `previous_meter_reading` comes from apartment's `water_meter_reading` field
- `current_meter_reading` is entered during bill generation

**Step 2: Calculate Price Per m³ (from WASAC Invoice)**
- `price_per_m3` = `total_invoice_amount` / `total_invoice_m3`
- This is auto-calculated from the water invoice

**Step 3: Calculate Water Charge**
- `water_amount` = `used_m3` × `price_per_m3`

**Step 4: Calculate Pompe (Pump) Electricity Charge**
- `pompe_price_per_m3` = `total_pompe_price_per_period` / `total_invoice_m3`
- `pompe_amount` = `used_m3` × `pompe_price_per_m3`
- Pompe settings are configured per building

**Step 5: Calculate Total Bill**
- `total_water_bill` = `water_amount` + `pompe_amount`

### Water Billing Workflow
1. **Admin creates Water Invoice** (WASAC Bill)
   - Input: Building, invoice number, dates, total m³, total amount
   - System auto-calculates price per m³
   
2. **Admin generates Water Bills**
   - Select invoice
   - Enter current meter readings for each apartment
   - System calculates bills automatically
   - Bills are saved to database
   - Previous meter readings are updated

3. **Send SMS Notifications**
   - Select bills to notify
   - System formats SMS with bill details
   - Tracks delivery status (sent, failed, no_phone)
   - Handles tenants without phone numbers

4. **Track Payments**
   - Mark bills as paid/unpaid
   - Record payment date
   - View payment status

### SMS Notification System (TextBee Integration)
- **Provider**: TextBee SMS Gateway (https://www.textbee.rw)
- **Configuration**: Admin Settings → SMS Settings
  - Enable/disable SMS notifications
  - TextBee API Key (required)
  - Sender name (max 11 characters)
- **Status Types**: pending, sent, failed, no_phone
- **Message Format**: Includes tenant name, apartment, period, usage, charges, total
- **Error Handling**: 
  - No phone number: Notify admin/manager
  - Failed delivery: Log error with TextBee response
  - API errors: Logged with connection details
- **Bulk Operations**: Send to multiple apartments at once
- **Real-time Tracking**: Delivery status per SMS
- **Resend Capability**: Retry failed SMS from Water Bills page

### Contract Management System
- **Location**: Apartment Details Page → Contract Management section (only visible for occupied apartments)
- **Templates**: Customizable lease agreement templates managed in Settings → Contract Templates
- **Placeholders**: Dynamic fields like `{{TENANT_NAME}}`, `{{RENT_AMOUNT}}`, `{{BUILDING_NAME}}`, etc.
- **Generation**: 
  - Select template from dropdown (shows default)
  - Auto-fill templates with apartment/tenant data
  - Download as text file: `Contract_{apartment_number}_{tenant_name}.txt`
  - Database values converted to proper format: `Number(value).toFixed(2)` for currency
- **Upload Signed Contract**: 
  - Drag-and-drop or click to upload
  - Supports: PDF, DOC, DOCX, JPG, PNG (max 10MB)
  - Saves to `/public/uploads/tenant_contract/` with unique timestamp
  - Updates apartment record with contract path
- **Download Signed Contract**: 
  - Green success button when contract exists
  - Opens contract in new tab/window
  - Available anytime after upload

### File Upload System
- **Supported Types**: 
  - Tenant ID/Passport documents
  - Signed lease contracts
  - Water invoice files (optional)
- **Storage**: `public/uploads/{type}/` directories
- **Max Size**: 10MB per file
- **Security**: Authenticated uploads only
- **Access Control**: Role-based download permissions

## Admin Interface Structure
The admin interface follows a modern card-based design with the following sections:

### Main Dashboard (`/admin`)
- Gradient header with welcome message
- 4 stat cards: Managers, Buildings, Apartments, Occupancy Rate
- Navigation menu organized by sections:
  - **Management**: Managers, Buildings & Apartments
  - **Reports & Analytics**: All report types
  - **Communication**: Notifications
  - **Settings**: Currency, Water Formula, General
  - **Profile**: Admin profile management

### Manager Management
- **List Page** (`/admin/managers`): Search, filter, view/edit/delete actions
- **Create Page** (`/admin/managers/create`): Form with validation
- **Edit Page** (`/admin/managers/[id]`): Update manager details

### Building Management
- **List Page** (`/admin/buildings`): Search, view building details
- **Create Page** (`/admin/buildings/create`): Add new building with manager assignment
- **Details Page** (`/admin/buildings/[id]`): Full building info, apartment list, quick actions
- **Edit Page** (`/admin/buildings/[id]/edit`): Update building information

### Apartment Management
- **List Page** (`/admin/apartments`): Search, multi-filter (building, occupancy), view all units
- **Create Page** (`/admin/apartments/create`): Add new apartment (unit number, floor, bedrooms, bathrooms, kitchen, rent, deposit, water meter reading). Apartments are created vacant; tenant info added via edit page.
- **Details Page** (`/admin/apartments/[id]`): Complete apartment and tenant information, contract management (generate, upload, download)
- **Edit Page** (`/admin/apartments/[id]/edit`): Update apartment and tenant details

### Apartment Data Model
- **Required Fields**: building_id, apartment_number, bedrooms, bathrooms, kitchen, rent_amount, water_meter_reading
- **Optional Fields**: floor_number, deposit_amount
- **Tenant Fields** (managed via edit page): tenant_name, tenant_id_passport, tenant_phone, tenant_phone_country_code, tenant_email, emergency_contact_name, emergency_contact_phone, lease_start_date, lease_end_date, is_occupied
- **Tenant Documents**: tenant_id_document_path, tenant_contract_path (file upload paths)
- **Removed Fields**: square_feet (not needed for this system)
- **Water Meter**: Tracks current water meter reading in cubic meters (m³) for billing purposes
- **Kitchen**: Boolean field indicating if the apartment has a kitchen (default: true)
- **Phone**: Includes country code field (default: +250 for Rwanda)

### Reports Section
- **Reports Hub** (`/admin/reports`): Navigation to all report types
- **Bill Reports** (`/admin/reports/bills`): Date range filtering
- **Payment Reports** (`/admin/reports/payments`): Payment analytics and stats
- **Apartment Reports** (`/admin/reports/apartments`): Occupancy and revenue stats
- **Building Reports** (`/admin/reports/buildings`): Building performance analytics

### Water Management
- **Water Invoices** (`/admin/water/invoices`): WASAC invoice management
  - Create new invoices with building, period, m³, amount
  - Auto-calculate price per m³
  - Generate bills button per invoice
  - Filter by building, search
- **Water Bills** (`/admin/water/bills`): Generated bills management
  - View all bills with filters (building, paid status)
  - Mark as paid/unpaid
  - Send SMS notifications (individual or bulk)
  - Select multiple bills for batch operations
  - SMS results modal with delivery status
- **Generate Bills** (`/admin/water/bills/generate`): Bill generation interface
  - Select invoice
  - Enter current meter readings
  - Real-time calculation preview
  - Validation (current >= previous)
  - Bulk generation for building
  
### Notifications
- **Notifications Hub** (`/admin/notifications`): 3 notification types
- **Maintenance** (`/admin/notifications/maintenance`): Maintenance alerts with priority
- **Water** (`/admin/notifications/water`): Water billing notifications (legacy - now in water bills)
- **Compound** (`/admin/notifications/compound`): General announcements

### Settings
- **Settings Hub** (`/admin/settings`): Navigation to settings
- **Currency** (`/admin/settings/currency`): Currency configuration with live preview (default: RWF)
- **Contract Templates** (`/admin/settings/contracts`): Lease agreement template management
  - Create/edit/delete templates
  - Set default template
  - Available placeholders documentation
  - Template preview
  - Copy placeholders to clipboard
- **SMS Settings** (`/admin/settings/sms`): TextBee SMS gateway configuration
  - Enable/disable SMS notifications
  - TextBee API key configuration
  - Sender name setup
  - Integration instructions

### Profile Management
- **Admin Profile** (`/admin/profile`): Two-tab interface (Profile Info & Security)
- Update personal information and change password

## Common Patterns
- Use React Hook Form for all forms
- Zod for runtime type validation with zodResolver
- Consistent error handling across components
- Loading states for all async operations
- Proper TypeScript typing for all functions
- Mobile-optimized touch interactions
- Input text visibility: use `text-gray-900 placeholder-gray-500` classes
- RESTful API design with proper HTTP status codes
- Dynamic routes with Next.js App Router: `[id]/page.tsx`
- Form validation on both client and server side
- Card-based layouts with shadows and hover effects
- Gradient backgrounds for headers and accent elements
- Color-coded sections for easy navigation
- Touch-friendly buttons (min 44px height)
- Consistent spacing and typography
- Toast notifications for user feedback
- Modals for complex forms and results display
- Bulk selection with checkbox patterns
- Real-time calculation previews
- File upload with progress indication
- Download buttons for uploaded documents
- Currency formatting based on system settings (position: before/after)
- Phone number formatting with country code
- Date formatting for periods and timestamps

### Water Billing UI Patterns
- **Invoice Cards**: Display invoice number, building, period, totals
- **Meter Reading Input**: Side-by-side previous/current with validation
- **Bill Calculation Preview**: Show breakdown (water + pompe = total)
- **SMS Status Indicators**: Color-coded icons (green=sent, red=failed, gray=no phone)
- **Bulk Actions Bar**: Sticky bar when items selected
- **Results Modal**: Show detailed SMS delivery results
- **Stats Cards**: Grid layout for totals, payments, counts
- **Filter Controls**: Building dropdown, paid status toggle, search

### File Upload Patterns
- Drag-and-drop or click to upload
- Preview uploaded file name/size
- Show download button for existing files
- Delete/replace file option
- File type and size validation
- Progress indicator during upload
- Store relative paths in database (`/uploads/{type}/{filename}`)

### Contract Generation Patterns
- Template selection dropdown
- Preview before download
- Placeholder documentation visible
- Fill all required fields validation
- Download as text/PDF
- Upload signed version back to system

## Database Enhancements
- `system_settings` table for configuration management
- `water_invoices` table for WASAC bills (building-specific, period-based)
- `water_bills` table for apartment water bills (auto-calculated amounts)
- `pompe_settings` table for pump electricity costs (per-building)
- `sms_notifications` table for SMS delivery logs
- `contract_templates` table for lease agreement templates
- `admin_dashboard_stats` view for dashboard statistics
- `building_performance` view for building analytics
- `payment_analytics` view for payment reporting
- `water_billing_summary` view for comprehensive water bill data
- `water_billing_analytics` view for building-wise water analytics
- `apartment_tenant_details` view for enhanced apartment info
- Default settings for currency (RWF) and SMS configuration
- Default contract template with placeholders
- Database triggers for automatic apartment count synchronization
  - `after_apartment_insert`: Updates building count on new apartment
  - `after_apartment_delete`: Updates building count on apartment deletion
  - `after_apartment_update`: Handles building changes when apartment is moved
- Generated columns in water_bills:
  - `used_m3`: auto-calculated from meter readings
  - `water_amount`: auto-calculated water charge
  - `pompe_amount`: auto-calculated pump charge
  - `total_amount`: auto-calculated total bill

Remember: This is a mobile-first application. Every feature should work perfectly on mobile devices before considering desktop adaptations. 